<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Путешествия</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #fff; }
    .top-bar { background: #f4f4f4; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
    .top-bar button { padding: 8px 16px; cursor: pointer; border: 1px solid #ccc; background: #eee; border-radius: 5px; }
    #map { height: 70vh; width: 100%; display: none; }
    #instruction { font-size: 0.9em; color: #555; text-align: center; margin: 20px 10px; }
    #personSelector { position: absolute; top: 50px; left: 10px; background: #fff; border: 1px solid #ccc; display: none; padding: 10px; border-radius: 5px; }
    #personSelector select { width: 200px; }
  </style>
</head>
<body>

<div class="top-bar">
  <button onclick="togglePersonSelector()">Люди</button>
  <button onclick="goToCreatePage()">Создать</button>
</div>

<div id="personSelector">
  <select id="personSelect" onchange="selectPerson()">
    <option selected disabled>Выберите путешественника</option>
  </select>
</div>

<div id="map"></div>

<div id="instruction">
  На этом сайте вы можете выбрать существующего путешественника или создать нового. После выбора будет показан маршрут его путешествий.
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let persons = {
  "Фёдор Конюхов": { publisher: "Известный путешественник", phone: "+79000000000", cities: ["Москва", "Мурманск", "Кейптаун"] },
  "Иван Бунин": { publisher: "Писатель и путешественник", phone: "+79000000001", cities: ["Воронеж", "Париж", "Ницца"] },
  "Николай Пржевальский": { publisher: "Исследователь", phone: "+79000000002", cities: ["Смоленск", "Улан-Батор", "Пекин"] }
};

let map;

function initializeMap() {
  if (!map) {
    map = L.map('map').setView([55.751244, 37.618423], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);
  }
}

function togglePersonSelector() {
  const selector = document.getElementById('personSelector');
  if (selector.style.display === 'none') {
    selector.style.display = 'block';
    loadPersons();
  } else {
    selector.style.display = 'none';
  }
}

function loadPersons() {
  const select = document.getElementById('personSelect');
  select.innerHTML = '<option selected disabled>Выберите путешественника</option>';
  Object.keys(persons).forEach(fio => {
    const option = document.createElement('option');
    option.value = fio;
    option.innerText = fio;
    select.appendChild(option);
  });
}

function selectPerson() {
  const fio = document.getElementById('personSelect').value;
  const person = persons[fio];
  if (!person) return;

  initializeMap();
  document.getElementById('map').style.display = 'block';

  map.eachLayer(layer => {
    if (layer instanceof L.Marker || layer instanceof L.Polyline) {
      map.removeLayer(layer);
    }
  });

  let coords = [];

  Promise.all(person.cities.map(city => getCoordinates(city))).then(results => {
    results.forEach((coord, index) => {
      if (coord) {
        coords.push(coord);
        L.marker(coord).addTo(map).bindPopup(person.cities[index]);
      }
    });

    if (coords.length >= 2) {
      L.polyline(coords, { color: 'blue' }).addTo(map);
    }

    if (coords.length > 0) {
      map.setView(coords[0], 6);
    }
  });
}

async function getCoordinates(city) {
  try {
    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`);
    const data = await response.json();
    if (data.length > 0) {
      return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
    } else {
      return null;
    }
  } catch (e) {
    return null;
  }
}

function goToCreatePage() {
  window.location.href = 'create.html';
}
</script>

</body>
</html>
