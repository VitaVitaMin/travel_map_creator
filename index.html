<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Путешествия</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #fff; }
    .top-bar { background: #f4f4f4; padding: 10px; display: flex; gap: 10px; justify-content: center; }
    .top-bar button { padding: 8px 16px; cursor: pointer; border: 1px solid #ccc; background: #eee; border-radius: 5px; }
    #map { height: 70vh; width: 100%; display: none; }
    .form-container { padding: 20px; display: none; }
    .form-container input { padding: 8px; margin: 5px 0; width: 100%; }
    .form-container button { margin-top: 10px; padding: 10px; width: 100%; }
    #instruction { font-size: 0.9em; color: #555; text-align: center; margin: 20px 10px; }
    ul { list-style: inside; padding: 0; }
  </style>
</head>
<body>

<div class="top-bar">
  <button onclick="loadPersons()">Выбрать персонажа</button>
  <button onclick="showCreateForm()">Создать</button>
</div>

<div id="personSelector" style="display:none; text-align:center; margin:10px;">
  <select id="personSelect">
    <option selected disabled>Выберите путешественника</option>
  </select>
</div>

<div id="formContainer" class="form-container">
  <h3>Добавить нового путешественника</h3>
  <input type="text" id="fio" placeholder="ФИО">
  <input type="text" id="publisher" placeholder="Кто публикует">
  <input type="text" id="phone" placeholder="Телефон">
  <input type="text" id="cityInput" placeholder="Добавить город">
  <button onclick="addCity()">Добавить город</button>
  <ul id="cityList"></ul>
  <button onclick="savePerson()">Сохранить</button>
</div>

<div id="map"></div>

<div id="instruction">
  На этом сайте вы можете выбрать существующего путешественника или создать нового. После выбора будет показан маршрут его путешествий.
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  let persons = {}; // база данных людей
  let loaded = false; // чтобы один раз загрузить список
  let currentCities = []; // для создания нового путешествия

  const userLang = navigator.language || navigator.userLanguage;

  let map;

  function initializeMap() {
    if (!map) {
      map = L.map('map').setView([55.751244, 37.618423], 5); // Москва
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);
    }
  }

  function loadPersons() {
    if (!loaded) {
      document.getElementById('personSelector').style.display = 'block';
      const select = document.getElementById('personSelect');
      select.innerHTML = '<option selected disabled>Выберите путешественника</option>';
      Object.keys(persons).forEach(fio => {
        const option = document.createElement('option');
        option.value = fio;
        option.innerText = fio;
        select.appendChild(option);
      });
      loaded = true;
    }
  }

  function showCreateForm() {
    document.getElementById('formContainer').style.display = 'block';
    document.getElementById('personSelector').style.display = 'none';
    document.getElementById('map').style.display = 'none';
  }

  function addCity() {
    const city = document.getElementById('cityInput').value.trim();
    if (!city) return alert('Введите название города');
    currentCities.push(city);
    updateCityList();
    document.getElementById('cityInput').value = '';
  }

  function updateCityList() {
    const list = document.getElementById('cityList');
    list.innerHTML = '';
    currentCities.forEach(city => {
      const li = document.createElement('li');
      li.innerText = city;
      list.appendChild(li);
    });
  }

  async function savePerson() {
    const fio = document.getElementById('fio').value.trim();
    const publisher = document.getElementById('publisher').value.trim();
    const phone = document.getElementById('phone').value.trim();

    if (!fio || !publisher || !phone || currentCities.length == 0) {
      return alert('Заполните все поля');
    }

    if (!/^[+]?\d{10,15}$/.test(phone)) {
      return alert('Неверный формат телефона');
    }

    const translatedInfo = await translateText(fio);

    persons[fio] = { publisher, phone, cities: [...currentCities], translatedName: translatedInfo };
    saveToLocalStorage();
    loaded = false;

    currentCities = [];
    updateCityList();
    document.getElementById('formContainer').style.display = 'none';
    alert('Путешественник добавлен!');
  }

  document.getElementById('personSelect').addEventListener('change', async function() {
    initializeMap();
    document.getElementById('map').style.display = 'block';

    const fio = this.value;
    const person = persons[fio];
    if (!person) return;

    map.eachLayer(layer => {
      if (layer instanceof L.Marker || layer instanceof L.Polyline) {
        map.removeLayer(layer);
      }
    });

    const coords = [];
    for (let city of person.cities) {
      const coord = await getCoordinates(city);
      if (coord) {
        coords.push(coord);
        L.marker(coord).addTo(map).bindPopup(city);
      } else {
        alert(`Город "${city}" не найден.`);
      }
    }

    if (coords.length >= 2) {
      L.polyline(coords, { color: 'blue' }).addTo(map);
    }

    if (coords.length > 0) {
      map.setView(coords[0], 6);
    }
  });

  async function getCoordinates(city) {
    try {
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`);
      const data = await response.json();
      if (data.length > 0) {
        return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
      } else {
        return null;
      }
    } catch (e) {
      return null;
    }
  }

  async function translateText(text) {
    try {
      const response = await fetch('https://libretranslate.com/translate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          q: text,
          source: 'ru',
          target: userLang.substr(0,2),
          format: 'text'
        })
      });
      const data = await response.json();
      return data.translatedText || text;
    } catch (e) {
      return text; // Если ошибка — вернуть оригинал
    }
  }

  function saveToLocalStorage() {
    localStorage.setItem('personsData', JSON.stringify(persons));
  }

  function loadFromLocalStorage() {
    const data = localStorage.getItem('personsData');
    if (data) {
      persons = JSON.parse(data);
    }
  }

  window.addEventListener('load', loadFromLocalStorage);
</script>

</body>
</html>
